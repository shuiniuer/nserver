#!/usr/bin/env node

var http=require('http');
var url=require('url');

http.createServer(function(req,res){
    //获得请求body
    var body='';
    req.on('data',function(chunk){
        body = body + chunk;
    });
    req.on('end',function(){
        var request_url=req.url;
        var option=url.parse(request_url);
        var httpObj='http:'==option.protocol?http:https;

        console.log('请求代理：'+request_url);
        //发送header
        req.headers.host=option.host;
        option.path=option.path?option.path:option.pathname+(option.search?option.search:'');
        req.headers.path=option.path;
        option.method=req.method;
        option.headers=req.headers;
        httpObj.request(option,function(result){
            //设置header
            for(var key in result.headers){
                res.setHeader(key,result.headers[key]);
            }
            result.on('data',function(chunk){
                res.write(chunk);
            });
            result.on('end',function(){
                res.end();
            });
        }).on('error',function(error){
            res.end('remote http.request error'+error);
        }).end(body);
    });
}).listen(8787);
console.log('监听8787端口');
